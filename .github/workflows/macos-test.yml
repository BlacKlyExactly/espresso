name: macOS Build & Test

on:
  push:
    branches: [main]
  pull_request:

jobs:
  build-and-test-macos:
    name: Build & Test on macOS
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Compile Espresso server
        run: |
          make
          test -f ./main || { echo "Error: main executable not found."; exit 1; }

      - name: Wait for port to clear
        run: sleep 30

      - name: Run server in background
        run: |
          ./main &
          sleep 3

      - name: Test endpoints
        run: |
          echo "Testing /"
          curl --fail "http://localhost:8080/"

          echo "Testing /api/"
          curl --fail "http://localhost:8080/api/"

          echo "Testing /api/echo?msg=HelloWorld"
          curl --fail "http://localhost:8080/api/echo?msg=HelloWorld"

      - name: Kill server
        if: always()
        run: pkill -f main || true
